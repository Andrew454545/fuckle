<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Positionle â€“ Guess the Position</title>
  <!-- Force GitHub Pages rebuild for Jungle Gym image -->
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #fff;
      padding: 2em;
      text-align: center;
    }

    img {
      max-width: 40%;
      height: auto;
      margin: 20px;
      border: 3px solid #444;
    }

    .tile-board {
      display: grid;
      grid-template-rows: repeat(5, 1fr);
      grid-gap: 5px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .tile-row {
      display: flex;
      justify-content: center;
      gap: 5px;
    }

    .tile {
      width: 60px;
      height: 60px;
      perspective: 1000px;
      position: relative;
    }

    .flip-inner {
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.6s ease;
      position: relative;
    }

    .flipped .flip-inner {
      transform: rotateY(180deg);
    }

    .flip-front, .flip-back {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      backface-visibility: hidden;
      font-size: 32px;
      font-weight: bold;
      color: white;
      border: 2px solid #444;
      background-color: #1a1a1a;
      box-sizing: border-box;
    }

    .flip-back {
      transform: rotateY(180deg);
    }

    .flip-back.correct { background-color: #6aaa64; }
    .flip-back.misplaced { background-color: #c9b458; }
    .flip-back.wrong { background-color: #787c7e; }

    .keyboard {
      margin-top: 20px;
    }

    .keyboard-row {
      display: flex;
      justify-content: center;
      margin: 5px 0;
    }

    .key {
      width: 40px;
      height: 50px;
      margin: 2px;
      font-size: 18px;
      border: none;
      border-radius: 4px;
      background-color: #444;
      color: white;
    }

    .key.correct { background-color: #6aaa64; }
    .key.misplaced { background-color: #c9b458; }
    .key.wrong { background-color: #787c7e; }
  </style>
</head>
<body>
  <h1>ðŸ¥‰ Positionle: Guess the Position</h1>
  <div style="display: flex; justify-content: center; align-items: flex-start; gap: 30px;">
    <img id="positionImage" src="" alt="Today's position image">
    <div class="tile-board" id="tileBoard"></div>
  </div>
  <div class="keyboard" id="keyboard"></div>

  <script>
    const maxGuesses = 5;
    let answer = '';
    let answerTitle = '';
    let guessCount = 0;
    const todayStr = new Date().toISOString().slice(0, 10);
    const todayKey = `position-of-day-${todayStr}`;
    let gameOver = false;
    const letterStatus = {};
    let currentGuess = ''; // Will contain full guess with spaces
    let typedLetters = []; // Array of letters user has typed (no spaces)
    let positionLink = null;

    function normalize(str) {
      return str.normalize("NFKD")
        .replace(/\p{Diacritic}/gu, "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '')
        .trim();
    }

    async function loadGame() {
      const res = await fetch('positions_metadata.json?t=' + Date.now());
      const data = await res.json();
      
      // Check for position parameter in URL
      const urlParams = new URLSearchParams(window.location.search);
      const positionParam = urlParams.get('position');
      
      let position;
      if (positionParam) {
        // Find position by number
        position = data.find(p => p.number === positionParam);
        if (!position) {
          // Fallback to random if not found
          const index = hashString(todayStr) % data.length;
          position = data[index];
        }
      } else {
        // For today, always use "Me when cooper goldsmith"
        position = data.find(p => p.title === "Me when cooper goldsmith");
        if (!position) {
          // Fallback to daily random position if not found
          const index = hashString(todayStr) % data.length;
          position = data[index];
        }
      }

      answerTitle = position.title;
      answer = normalize(position.title);
      document.getElementById('positionImage').src = position.image;

      const idMatch = position.image.match(/(\d+)_/);
      if (idMatch) {
        positionLink = `https://sexpositions.club/positions/${idMatch[1]}.html`;
      }

      renderTiles();
      renderKeyboard();
    }

    function hashString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = (hash << 5) - hash + str.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    function renderTiles() {
      const board = document.getElementById('tileBoard');
      board.innerHTML = '';
      for (let i = 0; i < maxGuesses; i++) {
        const row = document.createElement('div');
        row.className = 'tile-row';
        for (let j = 0; j < answerTitle.length; j++) {
          if (answerTitle[j] === ' ') {
            // Add a gap spacer instead of a tile for spaces
            const spacer = document.createElement('div');
            spacer.className = 'tile-spacer';
            spacer.style.width = '20px';
            row.appendChild(spacer);
          } else {
            const tile = document.createElement('div');
            tile.className = 'tile';
            tile.id = `tile-${i}-${j}`;
            tile.innerHTML = `
              <div class="flip-inner">
                <div class="flip-front"></div>
                <div class="flip-back"></div>
              </div>
            `;
            row.appendChild(tile);
          }
        }
        board.appendChild(row);
      }
    }

    function updateTiles(rowIndex, guess) {
      const answerArr = answerTitle.split('');
      const guessArr = guess.split('');
      const used = Array(answerArr.length).fill(false);

      const result = guessArr.map((letter, i) => {
        if (letter === answerArr[i]) {
          used[i] = true;
          return 'correct';
        }
        // Spaces must be in the exact position
        if (letter === ' ' || answerArr[i] === ' ') {
          return 'wrong';
        }
        return null;
      });

      guessArr.forEach((letter, i) => {
        if (result[i]) return;
        if (letter === ' ') {
          result[i] = 'wrong';
          return;
        }
        const idx = answerArr.findIndex((l, j) => !used[j] && l === letter && l !== ' ');
        if (idx !== -1) {
          result[i] = 'misplaced';
          used[idx] = true;
        } else {
          result[i] = 'wrong';
        }
      });

      // Use answerTitle position for tile ID (spaces don't have tiles, so skip them)
      guessArr.forEach((letter, i) => {
        if (letter === ' ') {
          // Skip spaces - they don't have tiles
          return;
        }
        // Tile ID uses the position in answerTitle (i), not a separate index
        const tile = document.getElementById(`tile-${rowIndex}-${i}`);
        if (!tile) return;
        const front = tile.querySelector('.flip-front');
        const back = tile.querySelector('.flip-back');

        front.textContent = letter.toUpperCase();
        back.textContent = letter.toUpperCase();
        back.classList.add(result[i]);

        const prev = letterStatus[letter];
        if (prev !== 'correct') letterStatus[letter] = result[i];

        // Count non-space letters for animation delay
        let letterCount = 0;
        for (let j = 0; j < i; j++) {
          if (answerTitle[j] !== ' ') letterCount++;
        }
        setTimeout(() => tile.classList.add('flipped'), letterCount * 300);
      });

      setTimeout(updateKeyboard, guessArr.length * 300);
    }

    function renderKeyboard() {
      const rows = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];
      const container = document.getElementById('keyboard');
      container.innerHTML = '';
      rows.forEach(row => {
        const div = document.createElement('div');
        div.className = 'keyboard-row';
        row.split('').forEach(char => {
          const btn = document.createElement('button');
          btn.textContent = char;
          btn.className = 'key';
          btn.id = `key-${char}`;
          btn.disabled = false;
          btn.onclick = () => handleInput(char);
          div.appendChild(btn);
        });
        container.appendChild(div);
      });
    }

    function updateKeyboard() {
      for (const letter in letterStatus) {
        const key = document.getElementById(`key-${letter.toUpperCase()}`);
        if (key) {
          key.classList.remove('correct', 'misplaced', 'wrong');
          key.classList.add(letterStatus[letter]);
        }
      }
    }

    function handleInput(char) {
      if (gameOver) return;
      if (char === ' ') return; // Spaces are auto-handled
      if (!answerTitle) return; // Make sure answerTitle is set
      
      // Count how many non-space letters are in answerTitle
      const totalLetters = answerTitle.split('').filter(c => c !== ' ').length;
      if (typedLetters.length >= totalLetters) return;
      
      // Add the typed letter
      typedLetters.push(char.toLowerCase());
      
      // Build currentGuess by inserting typed letters into answerTitle structure
      currentGuess = '';
      let letterIndex = 0;
      for (let i = 0; i < answerTitle.length; i++) {
        if (answerTitle[i] === ' ') {
          currentGuess += ' ';
        } else {
          if (letterIndex < typedLetters.length) {
            currentGuess += typedLetters[letterIndex];
            letterIndex++;
          } else {
            break; // Stop if we've used all typed letters
          }
        }
      }
      
      // Find the tile ID - need to map typed letter index to answerTitle position
      // typedLetters.length - 1 is the index of the letter we just added
      let tilePosition = -1;
      let letterCount = 0;
      for (let i = 0; i < answerTitle.length; i++) {
        if (answerTitle[i] !== ' ') {
          if (letterCount === typedLetters.length - 1) {
            tilePosition = i;
            break;
          }
          letterCount++;
        }
      }
      
      // Display in the correct tile
      if (tilePosition >= 0) {
        const tileId = `tile-${guessCount}-${tilePosition}`;
        const tile = document.getElementById(tileId);
        if (tile) {
          const front = tile.querySelector('.flip-front');
          if (front) {
            front.textContent = char.toUpperCase();
          }
        }
      }
    }

    function handleBackspace() {
      if (gameOver || typedLetters.length === 0) return;
      
      // Remove last typed letter
      typedLetters.pop();
      
      // Rebuild currentGuess
      currentGuess = '';
      let letterIndex = 0;
      for (let i = 0; i < answerTitle.length; i++) {
        if (answerTitle[i] === ' ') {
          currentGuess += ' ';
        } else {
          if (letterIndex < typedLetters.length) {
            currentGuess += typedLetters[letterIndex];
            letterIndex++;
          } else {
            break;
          }
        }
      }
      
      // Find the tile ID for the last letter
      let tilePosition = 0;
      let letterCount = 0;
      for (let i = 0; i < answerTitle.length; i++) {
        if (answerTitle[i] !== ' ') {
          if (letterCount === typedLetters.length) {
            tilePosition = i;
            break;
          }
          letterCount++;
        }
      }
      
      // Clear the tile
      const tile = document.getElementById(`tile-${guessCount}-${tilePosition}`);
      if (tile) tile.querySelector('.flip-front').textContent = '';
    }

    function handleEnter() {
      if (gameOver) return;
      
      // Count total letters needed
      const totalLetters = answerTitle.split('').filter(c => c !== ' ').length;
      if (typedLetters.length !== totalLetters) return;
      
      // currentGuess should already be built correctly from typedLetters
      const normalizedGuess = normalize(currentGuess);
      updateTiles(guessCount, currentGuess); // Pass original guess with spaces

      if (normalizedGuess === answer) {
        gameOver = true;
        showResult(true);
      } else if (++guessCount >= maxGuesses) {
        gameOver = true;
        showResult(false);
      }

      currentGuess = '';
      typedLetters = [];
      
      // Reset for next guess row
      if (guessCount < maxGuesses) {
        // Clear all tiles in the next row
        for (let j = 0; j < answerTitle.length; j++) {
          if (answerTitle[j] !== ' ') {
            const tile = document.getElementById(`tile-${guessCount}-${j}`);
            if (tile) {
              const front = tile.querySelector('.flip-front');
              if (front) front.textContent = '';
            }
          }
        }
      }
    }

    function showResult(won) {
      const message = document.createElement('div');
      message.style.marginTop = '20px';
      message.style.fontSize = '20px';
      message.textContent = won ? 'ðŸŽ‰ YOU GOT IT!' : `Out of guesses! Answer was: ${answerTitle}`;
      document.body.appendChild(message);

      if (positionLink) {
        const link = document.createElement('a');
        link.href = positionLink;
        link.textContent = 'ðŸ”— View This Position on SexPositions.club';
        link.target = '_blank';
        link.style.display = 'block';
        link.style.marginTop = '10px';
        link.style.fontSize = '18px';
        link.style.color = '#66f';
        document.body.appendChild(link);
      }
    }

    document.addEventListener('keydown', (e) => {
      if (/^[a-zA-Z]$/.test(e.key)) {
        handleInput(e.key.toUpperCase());
      } else if (e.key === 'Backspace') {
        handleBackspace();
      } else if (e.key === 'Enter') {
        handleEnter();
      }
    });

    loadGame();
  </script>
</body>
</html>
